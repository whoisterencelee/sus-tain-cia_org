<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title>Sustaincia</title>
  <meta name="description" content="Open Sustainability Platform for Everyone">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <meta name="referrer" content="no-referrer-when-downgrade"><!-- important https://web.dev/referrer-best-practices/ -->
  <meta name="theme-color" content="#fafafa">

  <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet"> 
</head>

<body style="background:#FFFCF4;font-family:Montserrat,san-serif;margin:0;">
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

	<script>$=(id=>document.getElementById(id)||{})</script>

	<style>
	div {display:flex;flex-direction:column;justify-content:center;align-items:center;flex-wrap:wrap;}
	.hide {display:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
	.unselectable {-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
	</style>

	<!-- seashell menu -->
	<!--
	<style>
		.hamburger {position:fixed;right:0;bottom:0;padding:1em 0.8em;}
		.hamburger:focus-within {opacity:1;}
		.hamburger:focus-within > #menu {display:block;}
	</style>
	<div class="hamburger" tabindex="3" >
		<img style="width:3em;height:auto;opacity:0.8;" src="icons/sustaincia-seashells-200302b-web.svg" />
		<div id="menu" class="hide">
			<a style="text-decoration:none;" href="https://sustaincia.com">social media platforms</a>
		</div>
	</div>
	-->


	<!-- header -->
	<div style="background:#0070c4;color:white;padding:1em;text-align:center;flex-direction:row;justify-content:space-evenly;">

		<!--<img src='sustaincia.svg' alt="Sustaincia" style="width:96px;height:96px;box-shadow:0px 0px 5px 0px white;border-radius:1em;margin-right:1em;"></img><br />-->
		<div style="font-size:3em;">inbox</div>

	</div>


	<!-- banner -->
	<style>
		.banner div{flex-grow:1}
		.ocean {margin:1em 7vw;text-align:center;width:100%;}
		.menu1:focus ~ #menu1 {display:block;}
		.menu2:focus ~ #menu2 {display:block;}
	</style>
	<div class="unselectable banner" style="flex-direction:row;justify-content:space-evenly;background:#4eadb8;color:white;padding:0.5em;box-shadow:0 5px 5px 0 lightgrey;">
	</div>

	<!-- Generated by https://smooth.ie/blogs/news/svg-wavey-transitions-between-sections -->
	<div style="height:5vh;overflow:hidden;" ><svg viewBox="0 20 500 66" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M0.00,49.98 C243.79,30.88 247.17,96.02 500.00,49.98 L500.00,0.00 L0.00,0.00 Z" style="stroke: none; fill: #4eadb8;"></path></svg></div>

	<style>
	.inbox > * { display:flex;flex-direction:row;justify-content:space-between;border-bottom:1px solid black;padding:1em 0;width:100%;align-items:start;cursor:pointer; }
	.inbox > *:hover { background:lightgrey; }
	.inbox > a { text-decoration:none;color:black;flex-wrap:wrap;word-break:break-all; }
	.inbox > a :nth-child(n+3) { color:grey; }
	</style>

	<div id="inbox" class="inbox" style="margin:0 3vw;font-family:monospace;">
	</div>
	<script>
// https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB
var dbschemas = { 
	inbox : { version : 1 , keyPath : "n" , autoIncrement : true , indices : [ 'time' ] } 
}
var db = {}
function openDb( dbname , func ) {
	console.log("openDb ...")
	var req = indexedDB.open( dbname , dbschemas[ dbname ].version )
	req.onsuccess = function (evt) {
		// Equal to: db = req.result;
		db[ dbname ] = this.result;
		console.log("openDb DONE");
		if( func ) func()
	}
	req.onerror = function (evt) {
		console.error("openDb:", evt.target.errorCode);
	}
	req.onupgradeneeded = function (evt) {
		console.log("openDb.onupgradeneeded");
		var objstore = evt.currentTarget.result.createObjectStore(
				dbname , dbschemas[ dbname ] 
				//dbname , { keyPath : dbschemas[ dbname ].keyPath } );
				//dbname , { keyPath: 'id', autoIncrement: true });
		)
		dbschemas[ dbname ].indices.forEach( index => objstore.createIndex( index , index , { unique: false }) )
		// unique = false allow insert of same key
	}
}

function store( dbname , data , func = ( stored ) => console.log( "stored " + JSON.stringify( stored ) ) ){
	try{
	if( !db[ dbname ] ) openDb( dbname , () => store( dbname , data , func ) )
	else{
		db[ dbname ].transaction( dbname , 'readwrite' ).objectStore( dbname ).add( data ).onsuccess = ( evt ) => {
			data[ dbschemas[ dbname ].keyPath ] = evt.target.result  // save the index into the returned obj
			func( data )
			}
	} // end of else
	} catch( e ){
		// TODO need to handle full storage
		console.log( e + " : problem storing : " + JSON.stringify( data ) )
		func( data )  // forgiving if cannot store still move on
	}
}
// var test = { time : new Date() }; store( "inbox" , test )

function read( dbname , index = db[ dbname ].keyPath , key , func = ( event ) => console.log( event.target.result ) ){
	if( !db[ dbname ] ) openDb( dbname , () => read( dbname , index , key , func ) )
	else if( index === null ) db[ dbname ].transaction( dbname , 'readonly' ).objectStore( dbname ).get( key ).onsuccess = func
	else db[ dbname ].transaction( dbname , 'readonly' ).objectStore( dbname ).index( index ).get( key ).onsuccess = func
}
// read( "inbox" , null , 1 ) // autoincrement starts at 1

function range( dbname , index = db[ dbname ].keyPath , lower , upper , func = ( event ) => console.log( event.target.result.value ) ){
	if( !db[ dbname ] ) return openDb( dbname , () => range( dbname , index , lower , upper , func ) )
	if( upper < lower ){  // descending order
		var temp = upper
		upper = lower
		lower = temp
		var prev = "prev"
	}
	db[ dbname ].transaction( dbname ).objectStore( dbname ).index( index ).openCursor( IDBKeyRange.bound( lower , upper , true , true ) , prev ).onsuccess = func
}

	range( "inbox" , "time" , new Date() , new Date().setDate( new Date().getDate() - 14 ) , ( event ) => {
		var cursor = event.target.result
		if( cursor ){ 
			console.log( cursor.value ); 

			var note = cursor.value
			var inbox = $( 'inbox' )
			var time = document.createElement( "div" )
			var title = document.createElement( "div" )
			var body = document.createElement( "div" )
			
			time.textContent = note.time.toLocaleString()
			title.textContent = note.title
			body.textContent = note.body

			var link = document.createElement( "a" )
			link.href = note.data.url
			link.appendChild( time )
			link.appendChild( title )
			link.appendChild( body )

			inbox.appendChild( link )

			cursor.continue() 
		} else console.log( "end of cursor" )
	})
	</script>
	
</body>

</html>
